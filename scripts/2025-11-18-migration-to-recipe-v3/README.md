# Migration to recipes v3

The time has come to migrate our recipes to version 3.
As a reminder they differ from version 2 by having extra properties called "templates", that fully capture the semantic of ingredients and steps.

## Requirements

Two stage migrations. Stage 1 converts recipes and writes them to disc. Stage 2 writes the recipes to CAPI.
The migration will be run on my laptop.

### Stage 1
- Create a state folder if one isnâ€™t passed as a parameter 
- Keep track of which recipe is processed with a CSV file, as well as the last modification date of the CAPI article 
- For each article in indexv2.json 
- call CAPI 
- extract recipes 
- call the templatiser 
- write an update to the state, store the recipe as a flat json file
- This process can be resumed by reading the CSV file and skipping already processed recipes
- The recipes are processed in parallel, with a parameter to control the parallelism

### Stage 2

- Check the v2 flag is correctly set. Throw an error otherwise 
- Group the recipes by their parent articles, to ensure writes are minimised as well as making the date check easier to understand 
- Check the article date matches the one in the CSV to ensure the migration was done on the latest version of the article.

# Diary

## 2025-11-18
- initialise repo
- import logic from previous spike
- have multiple threads for processing the recipes, but one to write the CSV file
- read the CSV file on startup to skip already processed recipes
- pre-process the data to re-compute the text field
  - this causes an issue where we have no amount:
    - either we ignore the unit when there's no amount and we're potentially missing data that wasn't properly structured
    - or we always add the unit, which is sometimes incorrect

# 2025-11-19
- Started working on stage 2
- Looking at the integration part of composer. TODO: will need to save the composer id during stage 1
- Local URL seems to be `https://import.flexible.local.dev-gutools.co.uk/recipes/import/set-recipe-elements/6915a1e3480e6e459ffd7924`
- where we use the composer and ID (and not the CAPI ID as I initially thought)
- Authentication is done with HMAC, need to test it. Looking at the configuration, it seems it's been removed from PROD and CODE. Will test adding it back locally.

# 2025-11-20
- Continue working on stage 2
- Fetching the article must happen through composer rather than CAPI as it's the source of truth.
- TODO:
  - [x] Fetch recipe from composer
  - [x] Find out where the HMAC key is stored => not needed with ssh tunnel
  - [x] Test SSM to create a tunnel to the integration instance
  - [x] Update logic to update all the recipes of an article in one go

# 2025-11-21
- Finished stage 2
- Test locally and on CODE. Most of code test data doesn't have a backing article, but managed to find around 75 articles for my test. Good enough
- stage 1 is pretty smooth at this stage
- stage 2 is still getting errors. I've updated the flexible-content PR to handle sponsorhip in the contributors field. Needs to be verified on Monday
```
  "logger_name": [
  "com.gu.flexiblecontent.integration.dispatcher.RecipesImportDispatcher"
  ],
  "message": [
  "aborting request with status 500, body: No usable value for contributors\nDo not know how to convert JObject(List(JField(type,JString(contributor)), JField(tagId,JString(profile/akwasi-brenya-mensa)))) into class java.lang.String"
  ],
  "stack_trace": [
  "java.lang.RuntimeException: Stack trace of call to halt\n\tat com.gu.flexiblecontent.dispatcher.JsonDispatcher$.com$gu$flexiblecontent$dispatcher$JsonDispatcher$$logHalt(JsonDispatcher.scala:64)\n\tat com.gu.flexiblecontent.dispatcher.JsonDispatcher.halt(JsonDispatcher.scala:40)\n\tat com.gu.flexiblecontent.dispatcher.JsonDispatcher.halt$(JsonDispatcher.scala:35)\n\tat com.gu.flexiblecontent.integration.dispatcher.Dispatcher.halt(Dispatcher.scala:10)\n\tat org.scalatra.Control.halt(Control.scala:30)\n\tat org.scalatra.Control.halt$(Control.scala:29)\n\tat com.gu.flexiblecontent.integration.dispatcher.Dispatcher.halt(Dispatcher.scala:10)\n\tat com.gu.flexiblecontent.integration.dispatcher.RecipesImportDispatcher.$anonfun$new$14(RecipesImportDispatcher.scala:125)\n\tat scala.Option.map(Option.scala:242)\n\tat com.gu.flexiblecontent.integration.dispatcher.RecipesImportDispatcher.$anonfun$new$13(RecipesImportDispatcher.scala:118)\n\tat scala.util.Success.map(Try.scala:270)\n\tat com.gu.flexiblecontent.integration.dispatcher.RecipesImportDispatcher.$anonfun$new$11(RecipesImportDispatcher.scala:114)\n\tat org.scalatra.ScalatraBase.liftAction(ScalatraBase.scala:282)\n\tat org.scalatra.ScalatraBase.$anonfun$invoke$1(ScalatraBase.scala:276)\n\tat org.scalatra.ApiFormats.withRouteMultiParams(ApiFormats.scala:180)\n\tat org.scalatra.ApiFormats.withRouteMultiParams$(ApiFormats.scala:171)\n\tat com.gu.flexiblecontent.integration.dispatcher.Dispatcher.withRouteMultiParams(Dispatcher.scala:10)\n\tat org.scalatra.ScalatraBase.invoke(ScalatraBase.scala:275)\n\tat org.scalatra.ScalatraBase.invoke$(ScalatraBase.scala:274)\n\tat com.gu.flexiblecontent.integration.dispatcher.Dispatcher.invoke(Dispatcher.scala:10)\n\tat org.scalatra.ScalatraBase.$anonfun$runRoutes$3(ScalatraBase.scala:250)\n\tat scala.Option.flatMap(Option.scala:283)\n\tat org.scalatra.ScalatraBase.$anonfun$runRoutes$1(ScalatraBase.scala:248)\n\tat scala.collection.immutable.Stream.flatMap(Stream.scala:200)\n\tat org.scalatra.ScalatraBase.runRoutes(ScalatraBase.scala:247)\n\tat org.scalatra.ScalatraBase.runRoutes$(ScalatraBase.scala:245)\n\tat com.gu.flexiblecontent.integration.dispatcher.Dispatcher.runRoutes(Dispatcher.scala:10)\n\tat org.scalatra.ScalatraBase.runActions$1(ScalatraBase.scala:169)\n\tat org.scalatra.ScalatraBase.$anonfun$executeRoutes$6(ScalatraBase.scala:181)\n\tat scala.runtime.java8.JFunction0$mcV$sp.apply(JFunction0$mcV$sp.scala:18)\n\tat org.scalatra.ScalatraBase.cradleHalt(ScalatraBase.scala:201)\n\tat org.scalatra.ScalatraBase.executeRoutes(ScalatraBase.scala:181)\n\tat org.scalatra.ScalatraBase.executeRoutes$(ScalatraBase.scala:150)\n\tat com.gu.flexiblecontent.integration.dispatcher.Dispatcher.executeRoutes(Dispatcher.scala:10)\n\tat org.scalatra.ScalatraBase.$anonfun$handle$1(ScalatraBase.scala:123)\n\tat scala.runtime.java8.JFunction0$mcV$sp.apply(JFunction0$mcV$sp.scala:18)\n\tat scala.util.DynamicVariable.withValue(DynamicVariable.scala:59)\n\tat org.scalatra.DynamicScope.withResponse(DynamicScope.scala:75)\n\tat org.scalatra.DynamicScope.withResponse$(DynamicScope.scala:73)\n\tat com.gu.flexiblecontent.integration.dispatcher.Dispatcher.withResponse(Dispatcher.scala:10)\n\tat org.scalatra.DynamicScope.$anonfun$withRequestResponse$1(DynamicScope.scala:55)\n\tat scala.util.DynamicVariable.withValue(DynamicVariable.scala:59)\n\tat org.scalatra.DynamicScope.withRequest(DynamicScope.scala:66)\n\tat org.scalatra.DynamicScope.withRequest$(DynamicScope.scala:64)\n\tat com.gu.flexiblecontent.integration.dispatcher.Dispatcher.withRequest(Dispatcher.scala:10)\n\tat org.scalatra.DynamicScope.withRequestResponse(DynamicScope.scala:54)\n\tat org.scalatra.DynamicScope.withRequestResponse$(DynamicScope.scala:52)\n\tat com.gu.flexiblecontent.integration.dispatcher.Dispatcher.withRequestResponse(Dispatcher.scala:10)\n\tat org.scalatra.ScalatraBase.handle(ScalatraBase.scala:123)\n\tat org.scalatra.ScalatraBase.handle$(ScalatraBase.scala:119)\n\tat com.gu.flexiblecontent.integration.dispatcher.Dispatcher.org$scalatra$servlet$ServletBase$$super$handle(Dispatcher.scala:10)\n\tat org.scalatra.servlet.ServletBase.handle(ServletBase.scala:42)\n\tat org.scalatra.servlet.ServletBase.handle$(ServletBase.scala:35)\n\tat com.gu.flexiblecontent.integration.dispatcher.Dispatcher.org$scalatra$scalate$ScalateSupport$$super$handle(Dispatcher.scala:10)\n\tat org.scalatra.scalate.ScalateSupport.handle(ScalateSupport.scala:139)\n\tat org.scalatra.scalate.ScalateSupport.handle$(ScalateSupport.scala:137)\n\tat com.gu.flexiblecontent.integration.dispatcher.Dispatcher.handle(Dispatcher.scala:10)\n\tat org.scalatra.ScalatraServlet.service(ScalatraServlet.scala:30)\n\tat org.scalatra.ScalatraServlet.service$(ScalatraServlet.scala:29)\n\tat com.gu.flexiblecontent.integration.dispatcher.Dispatcher.service(Dispatcher.scala:10)\n\tat javax.servlet.http.HttpServlet.service(HttpServlet.java:790)\n\tat org.eclipse.jetty.servlet.ServletHolder.handle(ServletHolder.java:799)\n\tat org.eclipse.jetty.servlet.ServletHandler$ChainEnd.doFilter(ServletHandler.java:1656)\n\tat com.gu.flexiblecontent.integration.filter.XForwardedFilter.doHttpFilter(XForwardedFilter.scala:51)\n\tat com.gu.flexiblecontent.integration.filter.XForwardedFilter.doFilter(XForwardedFilter.scala:35)\n\tat org.eclipse.jetty.servlet.FilterHolder.doFilter(FilterHolder.java:193)\n\tat org.eclipse.jetty.servlet.ServletHandler$Chain.doFilter(ServletHandler.java:1626)\n\tat com.gu.flexiblecontent.integration.filter.TrustedPortFilter.doFilter(TrustedPortFilter.scala:32)\n\tat org.eclipse.jetty.servlet.FilterHolder.doFilter(FilterHolder.java:193)\n\tat org.eclipse.jetty.servlet.ServletHandler$Chain.doFilter(ServletHandler.java:1626)\n\tat com.gu.management.servlet.ExceptionCaptureFilter.doHttpFilter(ExceptionCaptureFilter.scala:19)\n\tat com.gu.management.servlet.AbstractHttpFilter.doFilter(AbstractHttpFilter.scala:17)\n\tat com.gu.management.servlet.AbstractHttpFilter.doFilter$(AbstractHttpFilter.scala:10)\n\tat com.gu.management.servlet.ExceptionCaptureFilter.doFilter(ExceptionCaptureFilter.scala:7)\n\tat org.eclipse.jetty.servlet.FilterHolder.doFilter(FilterHolder.java:193)\n\tat org.eclipse.jetty.servlet.ServletHandler$Chain.doFilter(ServletHandler.java:1626)\n\tat com.gu.management.servlet.ResponseCodeCaptureFilter.doHttpFilter(ResponseCodeCaptureFilter.scala:61)\n\tat com.gu.management.servlet.AbstractHttpFilter.doFilter(AbstractHttpFilter.scala:17)\n\tat com.gu.management.servlet.AbstractHttpFilter.doFilter$(AbstractHttpFilter.scala:10)\n\tat com.gu.management.servlet.ResponseCodeCaptureFilter.doFilter(ResponseCodeCaptureFilter.scala:30)\n\tat org.eclipse.jetty.servlet.FilterHolder.doFilter(FilterHolder.java:193)\n\tat org.eclipse.jetty.servlet.ServletHandler$Chain.doFilter(ServletHandler.java:1626)\n\tat com.gu.management.servlet.ResponseCodeCaptureFilter.doHttpFilter(ResponseCodeCaptureFilter.scala:61)\n\tat com.gu.management.servlet.AbstractHttpFilter.doFilter(AbstractHttpFilter.scala:17)\n\tat com.gu.management.servlet.AbstractHttpFilter.doFilter$(AbstractHttpFilter.scala:10)\n\tat com.gu.management.servlet.ResponseCodeCaptureFilter.doFilter(ResponseCodeCaptureFilter.scala:30)\n\tat org.eclipse.jetty.servlet.FilterHolder.doFilter(FilterHolder.java:193)\n\tat org.eclipse.jetty.servlet.ServletHandler$Chain.doFilter(ServletHandler.java:1626)\n\tat com.gu.flexiblecontent.integration.filter.DefaultCacheControlFilter.doHttpFilter(DefaultCacheControlFilter.scala:32)\n\tat com.gu.flexiblecontent.integration.filter.DefaultCacheControlFilter.doFilter(DefaultCacheControlFilter.scala:20)\n\tat org.eclipse.jetty.servlet.FilterHolder.doFilter(FilterHolder.java:193)\n\tat org.eclipse.jetty.servlet.ServletHandler$Chain.doFilter(ServletHandler.java:1626)\n\tat com.gu.management.servlet.RequestLoggingFilter.doHttpFilter(RequestLoggingFilter.scala:128)\n\tat com.gu.management.servlet.AbstractHttpFilter.doFilter(AbstractHttpFilter.scala:17)\n\tat com.gu.management.servlet.AbstractHttpFilter.doFilter$(AbstractHttpFilter.scala:10)\n\tat com.gu.management.servlet.RequestLoggingFilter.doFilter(RequestLoggingFilter.scala:13)\n\tat org.eclipse.jetty.servlet.FilterHolder.doFilter(FilterHolder.java:193)\n\tat org.eclipse.jetty.servlet.ServletHandler$Chain.doFilter(ServletHandler.java:1626)\n\tat com.gu.flexiblecontent.filter.LogbackLoggingContextFilter.$anonfun$doHttpFilter$2(LogbackLoggingContextFilter.scala:43)\n\tat scala.runtime.java8.JFunction0$mcV$sp.apply(JFunction0$mcV$sp.scala:18)\n\tat com.gu.flexiblecontent.util.LoggingContext$.withContext(LoggingContext.scala:48)\n\tat com.gu.flexiblecontent.filter.LogbackLoggingContextFilter.doHttpFilter(LogbackLoggingContextFilter.scala:43)\n\tat com.gu.flexiblecontent.filter.AbstractHttpFilter.doFilter(AbstractHttpFilter.scala:17)\n\tat com.gu.flexiblecontent.filter.AbstractHttpFilter.doFilter$(AbstractHttpFilter.scala:10)\n\tat com.gu.flexiblecontent.filter.LogbackLoggingContextFilter.doFilter(LogbackLoggingContextFilter.scala:12)\n\tat org.eclipse.jetty.servlet.FilterHolder.doFilter(FilterHolder.java:193)\n\tat org.eclipse.jetty.servlet.ServletHandler$Chain.doFilter(ServletHandler.java:1626)\n\tat org.eclipse.jetty.servlet.ServletHandler.doHandle(ServletHandler.java:552)\n\tat org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:143)\n\tat org.eclipse.jetty.security.SecurityHandler.handle(SecurityHandler.java:600)\n\tat org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:127)\n\tat org.eclipse.jetty.server.handler.ScopedHandler.nextHandle(ScopedHandler.java:235)\n\tat org.eclipse.jetty.server.session.SessionHandler.doHandle(SessionHandler.java:1624)\n\tat org.eclipse.jetty.server.handler.ScopedHandler.nextHandle(ScopedHandler.java:233)\n\tat org.eclipse.jetty.server.handler.ContextHandler.doHandle(ContextHandler.java:1440)\n\tat org.eclipse.jetty.server.handler.ScopedHandler.nextScope(ScopedHandler.java:188)\n\tat org.eclipse.jetty.servlet.ServletHandler.doScope(ServletHandler.java:505)\n\tat org.eclipse.jetty.server.session.SessionHandler.doScope(SessionHandler.java:1594)\n\tat org.eclipse.jetty.server.handler.ScopedHandler.nextScope(ScopedHandler.java:186)\n\tat org.eclipse.jetty.server.handler.ContextHandler.doScope(ContextHandler.java:1355)\n\tat org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:141)\n\tat org.eclipse.jetty.server.handler.ContextHandlerCollection.handle(ContextHandlerCollection.java:191)\n\tat org.eclipse.jetty.server.handler.gzip.GzipHandler.handle(GzipHandler.java:722)\n\tat org.eclipse.jetty.server.handler.HandlerCollection.handle(HandlerCollection.java:146)\n\tat org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:127)\n\tat org.eclipse.jetty.server.Server.handle(Server.java:516)\n\tat org.eclipse.jetty.server.HttpChannel.lambda$handle$1(HttpChannel.java:487)\n\tat org.eclipse.jetty.server.HttpChannel.dispatch(HttpChannel.java:732)\n\tat org.eclipse.jetty.server.HttpChannel.handle(HttpChannel.java:479)\n\tat org.eclipse.jetty.server.HttpConnection.onFillable(HttpConnection.java:277)\n\tat org.eclipse.jetty.io.AbstractConnection$ReadCallback.succeeded(AbstractConnection.java:311)\n\tat org.eclipse.jetty.io.FillInterest.fillable(FillInterest.java:105)\n\tat org.eclipse.jetty.io.ChannelEndPoint$1.run(ChannelEndPoint.java:104)\n\tat org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.runTask(EatWhatYouKill.java:338)\n\tat org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.doProduce(EatWhatYouKill.java:315)\n\tat org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.tryProduce(EatWhatYouKill.java:173)\n\tat org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.run(EatWhatYouKill.java:131)\n\tat org.eclipse.jetty.util.thread.ReservedThreadExecutor$ReservedThread.run(ReservedThreadExecutor.java:409)\n\tat org.eclipse.jetty.util.thread.QueuedThreadPool.runJob(QueuedThreadPool.java:883)\n\tat org.eclipse.jetty.util.thread.QueuedThreadPool$Runner.run(QueuedThreadPool.java:1034)\n\tat java.base/java.lang.Thread.run(Thread.java:829)\n"
  ],
  "stack_trace.keyword": [
  "java.lang.RuntimeException: Stack trace of call to halt\n\tat com.gu.flexiblecontent.dispatcher.JsonDispatcher$.com$gu$flexiblecontent$dispatcher$JsonDispatcher$$logHalt(JsonDispatcher.scala:64)\n\tat com.gu.flexiblecontent.dispatcher.JsonDispatcher.halt(JsonDispatcher.scala:40)\n\tat com.gu.flexiblecontent.dispatcher.JsonDispatcher.halt$(JsonDispatcher.scala:35)\n\tat com.gu.flexiblecontent.integration.dispatcher.Dispatcher.halt(Dispatcher.scala:10)\n\tat org.scalatra.Control.halt(Control.scala:30)\n\tat org.scalatra.Control.halt$(Control.scala:29)\n\tat com.gu.flexiblecontent.integration.dispatcher.Dispatcher.halt(Dispatcher.scala:10)\n\tat com.gu.flexiblecontent.integration.dispatcher.RecipesImportDispatcher.$anonfun$new$14(RecipesImportDispatcher.scala:125)\n\tat scala.Option.map(Option.scala:242)\n\tat com.gu.flexiblecontent.integration.dispatcher.RecipesImportDispatcher.$anonfun$new$13(RecipesImportDispatcher.scala:118)\n\tat scala.util.Success.map(Try.scala:270)\n\tat com.gu.flexiblecontent.integration.dispatcher.RecipesImportDispatcher.$anonfun$new$11(RecipesImportDispatcher.scala:114)\n\tat org.scalatra.ScalatraBase.liftAction(ScalatraBase.scala:282)\n\tat org.scalatra.ScalatraBase.$anonfun$invoke$1(ScalatraBase.scala:276)\n\tat org.scalatra.ApiFormats.withRouteMultiParams(ApiFormats.scala:180)\n\tat org.scalatra.ApiFormats.withRouteMultiParams$(ApiFormats.scala:171)\n\tat com.gu.flexiblecontent.integration.dispatcher.Dispatcher.withRouteMultiParams(Dispatcher.scala:10)\n\tat org.scalatra.ScalatraBase.invoke(ScalatraBase.scala:275)\n\tat org.scalatra.ScalatraBase.invoke$(ScalatraBase.scala:274)\n\tat com.gu.flexiblecontent.integration.dispatcher.Dispatcher.invoke(Dispatcher.scala:10)\n\tat org.scalatra.ScalatraBase.$anonfun$runRoutes$3(ScalatraBase.scala:250)\n\tat scala.Option.flatMap(Option.scala:283)\n\tat org.scalatra.ScalatraBase.$anonfun$runRoutes$1(ScalatraBase.scala:248)\n\tat scala.collection.immutable.Stream.flatMap(Stream.scala:200)\n\tat org.scalatra.ScalatraBase.runRoutes(ScalatraBase.scala:247)\n\tat org.scalatra.ScalatraBase.runRoutes$(ScalatraBase.scala:245)\n\tat com.gu.flexiblecontent.integration.dispatcher.Dispatcher.runRoutes(Dispatcher.scala:10)\n\tat org.scalatra.ScalatraBase.runActions$1(ScalatraBase.scala:169)\n\tat org.scalatra.ScalatraBase.$anonfun$executeRoutes$6(ScalatraBase.scala:181)\n\tat scala.runtime.java8.JFunction0$mcV$sp.apply(JFunction0$mcV$sp.scala:18)\n\tat org.scalatra.ScalatraBase.cradleHalt(ScalatraBase.scala:201)\n\tat org.scalatra.ScalatraBase.executeRoutes(ScalatraBase.scala:181)\n\tat org.scalatra.ScalatraBase.executeRoutes$(ScalatraBase.scala:150)\n\tat com.gu.flexiblecontent.integration.dispatcher.Dispatcher.executeRoutes(Dispatcher.scala:10)\n\tat org.scalatra.ScalatraBase.$anonfun$handle$1(ScalatraBase.scala:123)\n\tat scala.runtime.java8.JFunction0$mcV$sp.apply(JFunction0$mcV$sp.scala:18)\n\tat scala.util.DynamicVariable.withValue(DynamicVariable.scala:59)\n\tat org.scalatra.DynamicScope.withResponse(DynamicScope.scala:75)\n\tat org.scalatra.DynamicScope.withResponse$(DynamicScope.scala:73)\n\tat com.gu.flexiblecontent.integration.dispatcher.Dispatcher.withResponse(Dispatcher.scala:10)\n\tat org.scalatra.DynamicScope.$anonfun$withRequestResponse$1(DynamicScope.scala:55)\n\tat scala.util.DynamicVariable.withValue(DynamicVariable.scala:59)\n\tat org.scalatra.DynamicScope.withRequest(DynamicScope.scala:66)\n\tat org.scalatra.DynamicScope.withRequest$(DynamicScope.scala:64)\n\tat com.gu.flexiblecontent.integration.dispatcher.Dispatcher.withRequest(Dispatcher.scala:10)\n\tat org.scalatra.DynamicScope.withRequestResponse(DynamicScope.scala:54)\n\tat org.scalatra.DynamicScope.withRequestResponse$(DynamicScope.scala:52)\n\tat com.gu.flexiblecontent.integration.dispatcher.Dispatcher.withRequestResponse(Dispatcher.scala:10)\n\tat org.scalatra.ScalatraBase.handle(ScalatraBase.scala:123)\n\tat org.scalatra.ScalatraBase.handle$(ScalatraBase.scala:119)\n\tat com.gu.flexiblecontent.integration.dispatcher.Dispatcher.org$scalatra$servlet$ServletBase$$super$handle(Dispatcher.scala:10)\n\tat org.scalatra.servlet.ServletBase.handle(ServletBase.scala:42)\n\tat org.scalatra.servlet.ServletBase.handle$(ServletBase.scala:35)\n\tat com.gu.flexiblecontent.integration.dispatcher.Dispatcher.org$scalatra$scalate$ScalateSupport$$super$handle(Dispatcher.scala:10)\n\tat org.scalatra.scalate.ScalateSupport.handle(ScalateSupport.scala:139)\n\tat org.scalatra.scalate.ScalateSupport.handle$(ScalateSupport.scala:137)\n\tat com.gu.flexiblecontent.integration.dispatcher.Dispatcher.handle(Dispatcher.scala:10)\n\tat org.scalatra.ScalatraServlet.service(ScalatraServlet.scala:30)\n\tat org.scalatra.ScalatraServlet.service$(ScalatraServlet.scala:29)\n\tat com.gu.flexiblecontent.integration.dispatcher.Dispatcher.service(Dispatcher.scala:10)\n\tat javax.servlet.http.HttpServlet.service(HttpServlet.java:790)\n\tat org.eclipse.jetty.servlet.ServletHolder.handle(ServletHolder.java:799)\n\tat org.eclipse.jetty.servlet.ServletHandler$ChainEnd.doFilter(ServletHandler.java:1656)\n\tat com.gu.flexiblecontent.integration.filter.XForwardedFilter.doHttpFilter(XForwardedFilter.scala:51)\n\tat com.gu.flexiblecontent.integration.filter.XForwardedFilter.doFilter(XForwardedFilter.scala:35)\n\tat org.eclipse.jetty.servlet.FilterHolder.doFilter(FilterHolder.java:193)\n\tat org.eclipse.jetty.servlet.ServletHandler$Chain.doFilter(ServletHandler.java:1626)\n\tat com.gu.flexiblecontent.integration.filter.TrustedPortFilter.doFilter(TrustedPortFilter.scala:32)\n\tat org.eclipse.jetty.servlet.FilterHolder.doFilter(FilterHolder.java:193)\n\tat org.eclipse.jetty.servlet.ServletHandler$Chain.doFilter(ServletHandler.java:1626)\n\tat com.gu.management.servlet.ExceptionCaptureFilter.doHttpFilter(ExceptionCaptureFilter.scala:19)\n\tat com.gu.management.servlet.AbstractHttpFilter.doFilter(AbstractHttpFilter.scala:17)\n\tat com.gu.management.servlet.AbstractHttpFilter.doFilter$(AbstractHttpFilter.scala:10)\n\tat com.gu.management.servlet.ExceptionCaptureFilter.doFilter(ExceptionCaptureFilter.scala:7)\n\tat org.eclipse.jetty.servlet.FilterHolder.doFilter(FilterHolder.java:193)\n\tat org.eclipse.jetty.servlet.ServletHandler$Chain.doFilter(ServletHandler.java:1626)\n\tat com.gu.management.servlet.ResponseCodeCaptureFilter.doHttpFilter(ResponseCodeCaptureFilter.scala:61)\n\tat com.gu.management.servlet.AbstractHttpFilter.doFilter(AbstractHttpFilter.scala:17)\n\tat com.gu.management.servlet.AbstractHttpFilter.doFilter$(AbstractHttpFilter.scala:10)\n\tat com.gu.management.servlet.ResponseCodeCaptureFilter.doFilter(ResponseCodeCaptureFilter.scala:30)\n\tat org.eclipse.jetty.servlet.FilterHolder.doFilter(FilterHolder.java:193)\n\tat org.eclipse.jetty.servlet.ServletHandler$Chain.doFilter(ServletHandler.java:1626)\n\tat com.gu.management.servlet.ResponseCodeCaptureFilter.doHttpFilter(ResponseCodeCaptureFilter.scala:61)\n\tat com.gu.management.servlet.AbstractHttpFilter.doFilter(AbstractHttpFilter.scala:17)\n\tat com.gu.management.servlet.AbstractHttpFilter.doFilter$(AbstractHttpFilter.scala:10)\n\tat com.gu.management.servlet.ResponseCodeCaptureFilter.doFilter(ResponseCodeCaptureFilter.scala:30)\n\tat org.eclipse.jetty.servlet.FilterHolder.doFilter(FilterHolder.java:193)\n\tat org.eclipse.jetty.servlet.ServletHandler$Chain.doFilter(ServletHandler.java:1626)\n\tat com.gu.flexiblecontent.integration.filter.DefaultCacheControlFilter.doHttpFilter(DefaultCacheControlFilter.scala:32)\n\tat com.gu.flexiblecontent.integration.filter.DefaultCacheControlFilter.doFilter(DefaultCacheControlFilter.scala:20)\n\tat org.eclipse.jetty.servlet.FilterHolder.doFilter(FilterHolder.java:193)\n\tat org.eclipse.jetty.servlet.ServletHandler$Chain.doFilter(ServletHandler.java:1626)\n\tat com.gu.management.servlet.RequestLoggingFilter.doHttpFilter(RequestLoggingFilter.scala:128)\n\tat com.gu.management.servlet.AbstractHttpFilter.doFilter(AbstractHttpFilter.scala:17)\n\tat com.gu.management.servlet.AbstractHttpFilter.doFilter$(AbstractHttpFilter.scala:10)\n\tat com.gu.management.servlet.RequestLoggingFilter.doFilter(RequestLoggingFilter.scala:13)\n\tat org.eclipse.jetty.servlet.FilterHolder.doFilter(FilterHolder.java:193)\n\tat org.eclipse.jetty.servlet.ServletHandler$Chain.doFilter(ServletHandler.java:1626)\n\tat com.gu.flexiblecontent.filter.LogbackLoggingContextFilter.$anonfun$doHttpFilter$2(LogbackLoggingContextFilter.scala:43)\n\tat scala.runtime.java8.JFunction0$mcV$sp.apply(JFunction0$mcV$sp.scala:18)\n\tat com.gu.flexiblecontent.util.LoggingContext$.withContext(LoggingContext.scala:48)\n\tat com.gu.flexiblecontent.filter.LogbackLoggingContextFilter.doHttpFilter(LogbackLoggingContextFilter.scala:43)\n\tat com.gu.flexiblecontent.filter.AbstractHttpFilter.doFilter(AbstractHttpFilter.scala:17)\n\tat com.gu.flexiblecontent.filter.AbstractHttpFilter.doFilter$(AbstractHttpFilter.scala:10)\n\tat com.gu.flexiblecontent.filter.LogbackLoggingContextFilter.doFilter(LogbackLoggingContextFilter.scala:12)\n\tat org.eclipse.jetty.servlet.FilterHolder.doFilter(FilterHolder.java:193)\n\tat org.eclipse.jetty.servlet.ServletHandler$Chain.doFilter(ServletHandler.java:1626)\n\tat org.eclipse.jetty.servlet.ServletHandler.doHandle(ServletHandler.java:552)\n\tat org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:143)\n\tat org.eclipse.jetty.security.SecurityHandler.handle(SecurityHandler.java:600)\n\tat org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:127)\n\tat org.eclipse.jetty.server.handler.ScopedHandler.nextHandle(ScopedHandler.java:235)\n\tat org.eclipse.jetty.server.session.SessionHandler.doHandle(SessionHandler.java:1624)\n\tat org.eclipse.jetty.server.handler.ScopedHandler.nextHandle(ScopedHandler.java:233)\n\tat org.eclipse.jetty.server.handler.ContextHandler.doHandle(ContextHandler.java:1440)\n\tat org.eclipse.jetty.server.handler.ScopedHandler.nextScope(ScopedHandler.java:188)\n\tat org.eclipse.jetty.servlet.ServletHandler.doScope(ServletHandler.java:505)\n\tat org.eclipse.jetty.server.session.SessionHandler.doScope(SessionHandler.java:1594)\n\tat org.eclipse.jetty.server.handler.ScopedHandler.nextScope(ScopedHandler.java:186)\n\tat org.eclipse.jetty.server.handler.ContextHandler.doScope(ContextHandler.java:1355)\n\tat org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:141)\n\tat org.eclipse.jetty.server.handler.ContextHandlerCollection.handle(ContextHandlerCollection.java:191)\n\tat org.eclipse.jetty.server.handler.gzip.GzipHandler.handle(GzipHandler.java:722)\n\tat org.eclipse.jetty.server.handler.HandlerCollection.handle(HandlerCollection.java:146)\n\tat org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:127)\n\tat org.eclipse.jetty.server.Server.handle(Server.java:516)\n\tat org.eclipse.jetty.server.HttpChannel.lambda$handle$1(HttpChannel.java:487)\n\tat org.eclipse.jetty.server.HttpChannel.dispatch(HttpChannel.java:732)\n\tat org.eclipse.jetty.server.HttpChannel.handle(HttpChannel.java:479)\n\tat org.eclipse.jetty.server.HttpConnection.onFillable(HttpConnection.java:277)\n\tat org.eclipse.jetty.io.AbstractConnection$ReadCallback.succeeded(AbstractConnection.java:311)\n\tat org.eclipse.jetty.io.FillInterest.fillable(FillInterest.java:105)\n\tat org.eclipse.jetty.io.ChannelEndPoint$1.run(ChannelEndPoint.java:104)\n\tat org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.runTask(EatWhatYouKill.java:338)\n\tat org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.doProduce(EatWhatYouKill.java:315)\n\tat org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.tryProduce(EatWhatYouKill.java:173)\n\tat org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.run(EatWhatYouKill.java:131)\n\tat org.eclipse.jetty.util.thread.ReservedThreadExecutor$ReservedThread.run(ReservedThreadExecutor.java:409)\n\tat org.eclipse.jetty.util.thread.QueuedThreadPool.runJob(QueuedThreadPool.java:883)\n\tat org.eclipse.jetty.util.thread.QueuedThreadPool$Runner.run(QueuedThreadPool.java:1034)\n\tat java.base/java.lang.Thread.run(Thread.java:829)\n"
  ],
```

# 2025-11-24
- spent most of the day debugging this error:
  - It turned out the actual exception was being swallowed (twice!). Once by the halt call, and a second time when parsing with a fallback to the older model, meaning we'd only get the error when trying to marshall the model back to the old model without knowing why it didn't succeed in the first place.
  - Added more logging to figure out what was going on
  - I've confirmed the underlying issue had nothing to do with the contributors, but the data in CODE isn't matching the logic, so it raises the exception.
  - I've got a minimal test case that reproduces the issue
  - Now to the question: do we have the same issue in production?
- To understand I need to dump all the production recipes, and attempt to parse them all locally. Time I didn't account for, but necessary.

# 2025-11-25
- extract minimal test case into this project to make it a CLI tool
  - Impossible to extract just the code I need into a self contained project.
  - Resorting to adding throwable temporary code into the flexible repo (not commit nor pushed)
  - writing a CLI that dumps recipe data from flexible into a folder
  - updating the test case to read from that folder and try to parse each recipe
  - if I make the unit of the `serves` property optional, then running it against production data and I can confirm 100% success, so this issue is a CODE only issue
  - merge PR with the fixed model (100% parse success against production data)
- launched the stage 1 of the migration (which is read only) on production, left it to run overnight will see the results tomorrow

# 2025-11-26
- checked the results of stage 1
  - it took 12 hours to process 6972 recipes
  - cost 310 USD, which is much lower than expected (was expecting around 600 USD)
  - 208 errors, of which:
    - 142 HTTP 504 from the templatiser. I'll retry these with a lower parallelism
    - 38 HTTP 500 from the templatiser. Need to investigate
    - 26 not found in CAPI, probably a desynchronisation issue between feast and CAPI
    - 2 not found in flexible, probably the same cause
  - 1275 diff automatically accepted by the LLM
  - 129 human review needed as flagged by the LLM
  - 5397 exact matches, (success)
- 504
  - deleted all the 504 from the CSV and re-triggering stage 1 with a lower parallelism: 1
    - still got 46 HTTP 504 after first retry. Will retry again, failing this I'll either bypass the ALB or extend its timeout
  - second retry: 22 HTTP 504 remaining
  - after multiple retries some still didn't go through, and they were all recipes with large amount of text instructions. I've tempararily increased the ALB timeout to 4 minutes and they all went through
  - This does beg the question of how to handle large recipes in the future. Is it a matter of icnreasing timeout and ask editors to be patients? or should we chunk the requests somehow?
